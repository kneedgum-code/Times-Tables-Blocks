<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Times Table Blocks: High Stakes Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(to bottom, #1a1a2e, #16213e);
            --grid-bg: #0f3460;
            --cell-bg: #1a1a2e;
            --accent: #e94560;
            --gold: #f1c40f;
            --gold-shadow: #b8860b;
        }

        body {
            background: var(--bg-gradient);
            color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            touch-action: none;
            transition: background 1s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: inherit;
            padding: 10px;
            transition: opacity 0.3s ease;
        }

        .hidden-screen {
            opacity: 0;
            pointer-events: none;
        }

        .grid-container {
            position: relative;
            width: 100%;
            max-width: 320px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            background: var(--grid-bg);
            padding: 6px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            aspect-ratio: 1 / 1;
        }

        .cell {
            background: var(--cell-bg);
            border-radius: 2px;
            transition: background 0.1s;
        }

        .piece-slot {
            width: 85px;
            height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .piece {
            display: grid;
            gap: 2px;
            cursor: grab;
            transform: scale(0.7);
        }

        .block {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        .table-chip {
            cursor: pointer;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffd700, #daa520);
            border: 2px solid #b8860b;
            border-radius: 50%;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: 900;
            color: #5c4000;
            margin: auto;
            box-shadow: 0 3px 0 #b8860b, inset 0 0 5px rgba(255,255,255,0.5);
            position: relative;
        }

        .table-chip.selected {
            background: var(--accent);
            color: white;
            border-color: #9b1c31;
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 5px 0 #9b1c31, 0 0 15px var(--accent);
        }

        .table-chip:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #b8860b;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 0.75rem;
        }

        #bonus-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            opacity: 0;
        }

        @keyframes popup {
            0% { opacity: 0; transform: translate(-50%, -20%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(0.8); }
        }

        .show-popup { animation: popup 1.5s forwards; }

        .blast-anim {
            animation: blast 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            z-index: 10;
        }

        @keyframes blast {
            0% { transform: scale(1); filter: brightness(1) white; background-color: white !important; }
            30% { transform: scale(1.1); filter: brightness(5); background-color: white !important; opacity: 1; box-shadow: 0 0 20px white; }
            100% { transform: scale(0); filter: brightness(10); opacity: 0; }
        }

        .timer-bar {
            height: 6px;
            background: #4ade80;
            width: 100%;
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .mic-btn {
            transition: all 0.2s;
            user-select: none;
        }
        .mic-btn.listening {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .gold-btn {
            background: linear-gradient(45deg, #f1c40f, #f39c12) !important;
            color: black !important;
        }
        
        .compact-input-container {
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .info-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-style: italic;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>

<!-- INFO OVERLAY -->
<div id="info-screen" class="screen hidden-screen bg-black/95 z-[1000]">
    <div class="max-w-xs text-center p-6 bg-gray-900 border border-blue-500 rounded-3xl">
        <h2 class="text-xl font-black text-blue-400 mb-4 uppercase">Speluitleg</h2>
        <ul class="text-left text-xs space-y-3 text-gray-300">
            <li>üß© <span class="text-white font-bold">Plaats blokken:</span> Sleep blokken naar het bord om lijnen te vullen.</li>
            <li>üöÄ <span class="text-white font-bold">Blast:</span> Een volle rij of kolom verdwijnt en geeft punten.</li>
            <li>üß† <span class="text-white font-bold">Save-ronde:</span> Als je vastloopt, kun je je score bewaren door 5 tafelsommen op te lossen.</li>
            <li>üéôÔ∏è <span class="text-white font-bold">Voice:</span> Gebruik de microfoon om antwoorden in te spreken (ingedrukt houden).</li>
            <li>üî• <span class="text-white font-bold">10 Tafels:</span> Kies alle tafels voor de 50s Double Challenge!</li>
        </ul>
        <button onclick="toggleInfo()" class="mt-6 w-full bg-blue-600 p-3 rounded-full font-bold uppercase text-sm">Snap ik!</button>
    </div>
</div>

<!-- MICROPHONE PERMISSION OVERLAY -->
<div id="mic-perm-screen" class="screen hidden-screen bg-black/95 z-[900]">
    <div class="max-w-xs text-center p-6 bg-gray-900 border border-red-500 rounded-3xl">
        <div class="text-4xl mb-4">üé§</div>
        <h2 class="text-xl font-black text-white mb-2 uppercase">Microfoon Toegang</h2>
        <p class="text-xs text-gray-400 mb-6 leading-relaxed">
            Voor de snelle rekenrondes kun je je stem gebruiken. Dit helpt om sneller te antwoorden zonder te typen!
        </p>
        <button onclick="requestMic()" class="w-full bg-red-600 p-4 rounded-full font-bold uppercase text-sm mb-3">Geef toestemming</button>
        <button onclick="skipMic()" class="text-xs text-gray-500 underline uppercase">Zonder spraak spelen</button>
    </div>
</div>

<!-- START SCREEN -->
<div id="start-screen" class="screen">
    <div class="info-btn" onclick="toggleInfo()">i</div>
    <h1 class="text-3xl font-black mb-0 italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-pink-500 text-center uppercase">Times Table Blocks</h1>
    <p class="text-blue-300 mb-4 uppercase tracking-widest text-[8px]">High Stakes Edition</p>
    
    <div class="w-full max-w-xs space-y-4">
        <input type="text" id="player-name" placeholder="Je naam..." class="w-full p-3 rounded-full bg-gray-800 border-2 border-blue-500 text-center text-md outline-none focus:border-pink-500 text-white">
        
        <div class="space-y-2">
            <p class="text-[9px] font-bold text-gray-500 text-center uppercase tracking-widest">Selecteer Gouden Tafels:</p>
            <div class="grid grid-cols-5 gap-y-2" id="table-selection"></div>
        </div>

        <div class="flex justify-center gap-2">
            <button onclick="selectRange(1, 5)" class="preset-btn font-bold uppercase">1-5</button>
            <button onclick="selectRange(6, 10)" class="preset-btn font-bold uppercase">6-10</button>
            <button onclick="selectRange(1, 10)" class="preset-btn font-bold uppercase text-yellow-500 border-yellow-500/30">Alle</button>
        </div>
        
        <button id="start-btn" onclick="checkMicAndStart()" class="w-full bg-white text-black p-4 font-black text-md hover:scale-105 transition uppercase rounded-full shadow-lg">Start Training</button>
        <p id="mode-hint" class="text-[9px] text-center text-gray-500 uppercase tracking-tight">Kies 10 tafels voor de 50s Dubbel-Bonus!</p>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen hidden-screen">
    <div class="flex justify-between w-full max-w-[320px] mb-2 px-1">
        <div class="text-2xl font-black" id="score-display">0</div>
        <div class="text-right text-[10px] text-gray-400 italic" id="active-player"></div>
    </div>
    <div class="grid-container">
        <div id="grid" class="grid"></div>
        <div id="bonus-popup" class="text-3xl text-yellow-400 drop-shadow-lg italic font-black">COMBO!</div>
    </div>
    <div class="flex justify-around w-full max-w-[320px] mt-4">
        <div class="piece-slot" id="slot-0"></div>
        <div class="piece-slot" id="slot-1"></div>
        <div class="piece-slot" id="slot-2"></div>
    </div>
</div>

<!-- GAME OVER FLOW -->
<div id="flow-modal" class="screen hidden-screen z-[100] bg-black/95">
    <div class="w-full max-w-xs text-center px-4">
        <h2 class="text-2xl font-black text-red-500 mb-1 italic uppercase">Geen zetten meer!</h2>
        <p class="text-gray-400 mb-4 text-[11px]">Maak 5 tafels om te bewaren...</p>
        
        <div class="bg-gray-900 p-6 border-2 border-blue-500 relative rounded-2xl compact-input-container">
            <div class="flex justify-center gap-2 mb-4" id="flow-dots"></div>
            <p id="flow-question" class="text-6xl font-black mb-4 text-white"></p>
            
            <div class="flex gap-2 mb-4">
                <input type="number" id="flow-input" class="w-24 p-3 bg-black border border-gray-700 text-center text-3xl font-bold outline-none text-white rounded-lg" placeholder="?">
                <button id="flow-mic" class="mic-btn flex-1 bg-gray-800 flex items-center justify-center text-white text-xl border border-gray-700 rounded-lg">üé§</button>
            </div>
            
            <button id="flow-submit" class="w-full bg-blue-600 p-3 font-bold text-lg text-white uppercase rounded-full">Bevestig</button>
        </div>
        <div id="flow-fact" class="mt-4 text-[10px] text-blue-300 italic px-4"></div>
    </div>
</div>

<!-- DOUBLE OR NOTHING -->
<div id="choice-modal" class="screen hidden-screen z-[110] bg-black/98">
    <div class="text-center p-4 w-full max-w-xs">
        <h2 class="text-3xl font-black text-yellow-400 mb-2 italic uppercase">Alles of niets?</h2>
        <p class="mb-6 text-gray-300 text-sm">Score: <span id="current-end-score" class="font-bold text-white text-xl">0</span></p>
        
        <div class="space-y-3">
            <button onclick="finishGame()" class="w-full bg-gray-800 p-4 font-bold border border-gray-600 uppercase text-sm rounded-full">Score opslaan</button>
            <button onclick="prepareChallenge()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black p-5 font-black text-lg uppercase shadow-lg rounded-full">Dubbel je score!</button>
        </div>
    </div>
</div>

<!-- CHALLENGE SCREEN -->
<div id="challenge-modal" class="screen hidden-screen z-[120] bg-black">
    <div class="w-full max-w-xs text-center px-4">
        <div class="flex justify-between items-end mb-4 px-2">
            <div class="text-left">
                <div id="chall-count" class="text-3xl font-black text-white">25</div>
            </div>
            <div class="text-right w-1/2 mb-1">
                <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                    <div class="timer-bar" id="chall-timer"></div>
                </div>
            </div>
        </div>
        
        <div class="bg-white text-black p-6 rounded-3xl compact-input-container">
            <p id="chall-question" class="text-6xl font-black mb-4"></p>
            <div class="flex gap-2">
                <input type="number" id="chall-input" class="w-24 p-3 bg-gray-100 border-2 border-gray-300 text-center text-4xl font-black outline-none focus:border-yellow-500 rounded-xl" placeholder="?">
                <button id="chall-mic" class="mic-btn flex-1 bg-gray-200 flex items-center justify-center text-2xl border-2 border-gray-300 rounded-xl">üé§</button>
            </div>
        </div>
        <p id="chall-status-msg" class="mt-4 text-[10px] text-yellow-500 font-bold uppercase tracking-widest">Eerste antwoord start de 50s klok...</p>
    </div>
</div>

<!-- FINAL GAME OVER -->
<div id="game-over-screen" class="screen hidden-screen z-[200]">
    <h1 class="text-4xl font-black text-red-500 mb-1 italic uppercase">Resultaat</h1>
    <p class="text-6xl font-black text-white" id="final-score-val">0</p>
    <p class="text-yellow-400 font-bold uppercase tracking-widest text-[10px] mb-6" id="score-status"></p>
    <div class="w-full max-w-[280px] bg-gray-900/50 p-4 border border-gray-700 rounded-xl">
        <div id="highscore-list" class="space-y-2 text-xs"></div>
    </div>
    <button onclick="location.reload()" class="mt-6 bg-white text-black px-10 py-4 font-black text-lg shadow-xl uppercase rounded-full">Opnieuw</button>
</div>

<script>
    // State
    const GRID_SIZE = 8;
    const CHALLENGE_TIME = 50; // Verlengd naar 50 seconden voor de Double Challenge
    let score = 0;
    let grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
    let activePieces = [null, null, null];
    let selectedTables = [];
    let playerName = "Speler";
    let isAnimating = false;
    let draggedPiece = null;
    let micPermissionAsked = false;

    const scienceFacts = [
        "Wist je dat? Als je tafels automatisch weet, krijgt je werkgeheugen meer ruimte voor moeilijke sommen!",
        "Je brein werkt als een spier: door tafels te trainen maak je 'snelwegen' van neuronen aan.",
        "Wetenschap zegt: snelle tafels zorgen voor minder stress tijdens wiskunde-toetsen.",
        "Automatiseren betekent dat de info van je 'denk-brein' naar je 'doe-brein' verhuist.",
        "Neuroplasticiteit: je hersenen veranderen letterlijk van vorm als je deze tafels traint!",
        "Tafels zijn de 'LEGO-blokjes' van bijna alle wiskunde.",
        "Je hersenen verbruiken minder energie als je antwoorden direct weet zonder na te denken.",
        "Hoe vaker je oefent, hoe dikker de beschermlaag (myeline) om je hersencellen wordt."
    ];

    // Voice setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.lang = 'nl-NL';
        recognition.interimResults = false;
    }

    function setupMicEvents(btnId, targetId, onSuccess) {
        const btn = document.getElementById(btnId);
        const input = document.getElementById(targetId);
        
        const startListening = (e) => {
            e.preventDefault();
            if (!recognition || isListening) return;
            isListening = true;
            btn.classList.add('listening');
            try {
                recognition.start();
            } catch(e) {}
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                const number = transcript.replace(/[^0-9]/g, '');
                if (number) {
                    input.value = number;
                    if (onSuccess) onSuccess();
                }
            };
        };
        const stopListening = (e) => {
            e.preventDefault();
            if (!recognition || !isListening) return;
            isListening = false;
            btn.classList.remove('listening');
            recognition.stop();
        };
        btn.addEventListener('mousedown', startListening);
        btn.addEventListener('mouseup', stopListening);
        btn.addEventListener('touchstart', startListening);
        btn.addEventListener('touchend', stopListening);
    }

    function toggleInfo() {
        document.getElementById('info-screen').classList.toggle('hidden-screen');
    }

    function checkMicAndStart() {
        if(selectedTables.length === 0) return alert("Kies eerst je tafels!");
        if(!micPermissionAsked && SpeechRecognition) {
            document.getElementById('mic-perm-screen').classList.remove('hidden-screen');
        } else {
            startGame();
        }
    }

    function requestMic() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => {
                micPermissionAsked = true;
                document.getElementById('mic-perm-screen').classList.add('hidden-screen');
                startGame();
            })
            .catch(() => {
                skipMic();
            });
    }

    function skipMic() {
        micPermissionAsked = true;
        document.getElementById('mic-perm-screen').classList.add('hidden-screen');
        startGame();
    }

    function init() {
        const container = document.getElementById('table-selection');
        for(let i=1; i<=10; i++) {
            const chip = document.createElement('div');
            chip.className = 'table-chip';
            chip.id = `chip-${i}`;
            chip.innerText = i;
            chip.onclick = () => toggleTable(i);
            container.appendChild(chip);
        }
        setupMicEvents('flow-mic', 'flow-input');
        setupMicEvents('chall-mic', 'chall-input', checkChallAnswer);
    }

    function toggleTable(i) {
        const chip = document.getElementById(`chip-${i}`);
        chip.classList.toggle('selected');
        if(selectedTables.includes(i)) selectedTables = selectedTables.filter(t => t !== i);
        else selectedTables.push(i);
        updateStartUI();
    }

    function selectRange(start, end) {
        selectedTables = [];
        for(let i=1; i<=10; i++) {
            const chip = document.getElementById(`chip-${i}`);
            if(i >= start && i <= end) {
                chip.classList.add('selected');
                selectedTables.push(i);
            } else chip.classList.remove('selected');
        }
        updateStartUI();
    }

    function updateStartUI() {
        const startBtn = document.getElementById('start-btn');
        const modeHint = document.getElementById('mode-hint');
        if(selectedTables.length === 10) {
            startBtn.classList.add('gold-btn');
            modeHint.innerText = "Double Challenge Ontgrendeld! üî•";
            modeHint.classList.add('text-yellow-400');
        } else {
            startBtn.classList.remove('gold-btn');
            modeHint.innerText = "Kies 10 tafels voor de 50s Dubbel-Bonus!";
            modeHint.classList.remove('text-yellow-400');
        }
    }

    function startGame() {
        const nameIn = document.getElementById('player-name').value;
        if(nameIn) playerName = nameIn;
        document.getElementById('start-screen').classList.add('hidden-screen');
        document.getElementById('game-screen').classList.remove('hidden-screen');
        document.getElementById('active-player').innerText = `${playerName}`;
        renderGrid();
        generatePieces();
    }

    function renderGrid() {
        const g = document.getElementById('grid');
        g.innerHTML = '';
        for(let r=0; r<GRID_SIZE; r++) {
            for(let c=0; c<GRID_SIZE; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${r}-${c}`;
                cell.dataset.r = r;
                cell.dataset.c = c;
                g.appendChild(cell);
            }
        }
    }

    const COLORS = ['#FF5E5E', '#FFB84E', '#4E9FFF', '#4EFAFF', '#B04EFF', '#7DFF4E', '#F1C40F'];
    
    // Vari√´teit aan blokken inclusief de 3x3 en grote L
    const PIECE_TYPES = [
        [[1,1]], // 1x2
        [[1],[1]], // 2x1
        [[1,1,1]], // 1x3
        [[1,1],[1,1]], // 2x2
        [[1,1,1],[0,1,0]], // T-vorm
        [[1,1,1,1]], // 1x4
        [[1,0],[1,0],[1,1]], // L-vorm (klein)
        [[1,1,1],[1,1,1],[1,1,1]], // 3x3 Vierkant
        [[1,1,1],[1,0,0],[1,0,0]], // Grote L-vorm
        [[1,1,0],[0,1,1]], // Z-vorm
        [[0,1,1],[1,1,0]], // S-vorm
        [[1,1,1],[1,1,1]], // 2x3 Rechthoek
        [[1]] // Enkel blokje
    ];

    function generatePieces() {
        [0,1,2].forEach(i => {
            const type = PIECE_TYPES[Math.floor(Math.random()*PIECE_TYPES.length)];
            const color = COLORS[Math.floor(Math.random()*COLORS.length)];
            activePieces[i] = { shape: type, color };
            renderPiece(i);
        });
    }

    function renderPiece(slotIdx) {
        const slot = document.getElementById(`slot-${slotIdx}`);
        slot.innerHTML = '';
        if(!activePieces[slotIdx]) return;
        const p = activePieces[slotIdx];
        const el = document.createElement('div');
        el.className = 'piece';
        el.style.gridTemplateColumns = `repeat(${p.shape[0].length}, 1fr)`;
        el.draggable = true;
        p.shape.forEach(row => row.forEach(c => {
            const b = document.createElement('div');
            b.className = 'block';
            if(c) b.style.backgroundColor = p.color;
            else b.style.visibility = 'hidden';
            el.appendChild(b);
        }));
        el.ondragstart = (e) => { draggedPiece = { ...p, slotIdx }; };
        el.ontouchstart = (e) => handleTouch(e, slotIdx);
        slot.appendChild(el);
    }

    function handleTouch(e, slotIdx) {
        if(isAnimating) return;
        e.preventDefault();
        draggedPiece = { ...activePieces[slotIdx], slotIdx };
        const ghost = e.currentTarget.cloneNode(true);
        ghost.style.position = 'fixed'; ghost.style.pointerEvents = 'none'; ghost.style.zIndex = '1000'; ghost.style.transform = 'scale(1.2) translateY(-60px)';
        document.body.appendChild(ghost);
        const move = (me) => {
            const t = me.touches[0];
            ghost.style.left = (t.clientX - 35) + 'px'; ghost.style.top = (t.clientY - 60) + 'px';
            const cell = document.elementFromPoint(t.clientX, t.clientY - 80);
            if(cell && cell.dataset.r) showPreview(parseInt(cell.dataset.r), parseInt(cell.dataset.c));
            else clearPreviews();
        };
        const end = (ee) => {
            const t = ee.changedTouches[0];
            const cell = document.elementFromPoint(t.clientX, t.clientY - 80);
            if(cell && cell.dataset.r) tryPlace(parseInt(cell.dataset.r), parseInt(cell.dataset.c));
            ghost.remove(); clearPreviews();
            document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end);
        };
        document.addEventListener('touchmove', move); document.addEventListener('touchend', end);
    }

    document.getElementById('grid').ondragover = (e) => {
        e.preventDefault();
        const cell = e.target.closest('.cell');
        if(cell) showPreview(parseInt(cell.dataset.r), parseInt(cell.dataset.c));
    };
    document.getElementById('grid').ondragleave = () => clearPreviews();
    document.getElementById('grid').ondrop = (e) => {
        const cell = e.target.closest('.cell');
        if(cell) tryPlace(parseInt(cell.dataset.r), parseInt(cell.dataset.c));
        clearPreviews();
    };

    function showPreview(r, c) {
        clearPreviews();
        if(!draggedPiece || isAnimating) return;
        const s = draggedPiece.shape;
        const canFit = canPlace(r, c, s);
        s.forEach((row, dr) => {
            row.forEach((cell, dc) => {
                if(cell) {
                    const el = document.getElementById(`cell-${r+dr}-${c+dc}`);
                    if(el) el.style.backgroundColor = canFit ? 'rgba(255,255,255,0.4)' : 'rgba(255,0,0,0.4)';
                }
            });
        });
    }

    function clearPreviews() {
        document.querySelectorAll('.cell').forEach(c => {
            const val = grid[c.dataset.r][c.dataset.c];
            c.style.backgroundColor = val === 0 ? 'var(--cell-bg)' : val;
        });
    }

    function canPlace(r, c, shape) {
        for(let dr=0; dr<shape.length; dr++) {
            for(let dc=0; dc<shape[0].length; dc++) {
                if(shape[dr][dc]) {
                    const nr = r+dr, nc = c+dc;
                    if(nr>=GRID_SIZE || nc>=GRID_SIZE || grid[nr][nc]!==0) return false;
                }
            }
        }
        return true;
    }

    function tryPlace(r, c) {
        if(!draggedPiece || isAnimating) return;
        const s = draggedPiece.shape;
        if(canPlace(r, c, s)) {
            s.forEach((row, dr) => row.forEach((cell, dc) => { if(cell) grid[r+dr][c+dc] = draggedPiece.color; }));
            score += 10;
            activePieces[draggedPiece.slotIdx] = null;
            document.getElementById(`slot-${draggedPiece.slotIdx}`).innerHTML = '';
            checkLines();
            updateUI();
            if(activePieces.every(p => p===null)) generatePieces();
            checkGameOver();
        }
        draggedPiece = null;
    }

    async function checkLines() {
        let rs = [], cs = [];
        for(let i=0; i<GRID_SIZE; i++) {
            if(grid[i].every(v => v!==0)) rs.push(i);
            if(grid.every(r => r[i]!==0)) cs.push(i);
        }
        if(rs.length + cs.length > 0) {
            isAnimating = true;
            rs.forEach(r => { 
                for(let i=0; i<GRID_SIZE; i++) document.getElementById(`cell-${r}-${i}`).classList.add('blast-anim'); 
            });
            cs.forEach(c => { 
                for(let i=0; i<GRID_SIZE; i++) document.getElementById(`cell-${i}-${c}`).classList.add('blast-anim'); 
            });
            
            await new Promise(res => setTimeout(res, 600));
            
            rs.forEach(r => grid[r].fill(0));
            cs.forEach(c => grid.forEach(r => r[c]=0));
            score += (rs.length + cs.length) * 100;
            if(rs.length + cs.length >= 2) showBonus();
            isAnimating = false;
            updateUI();
        }
    }

    function showBonus() {
        const p = document.getElementById('bonus-popup');
        p.classList.remove('show-popup'); void p.offsetWidth; p.classList.add('show-popup');
    }

    function updateUI() {
        document.querySelectorAll('.cell').forEach(c => {
            const v = grid[c.dataset.r][c.dataset.c];
            c.style.backgroundColor = v===0 ? 'var(--cell-bg)' : v;
            c.classList.remove('blast-anim');
        });
        document.getElementById('score-display').innerText = score;
    }

    function checkGameOver() {
        let canAny = false;
        activePieces.forEach(p => {
            if(!p) return;
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE; c++) {
                    if(canPlace(r, c, p.shape)) canAny = true;
                }
            }
        });
        if(!canAny && activePieces.some(p => p!==null)) startGameOverFlow();
    }

    let flowCount = 0;
    let flowTarget = 0;
    function startGameOverFlow() {
        document.getElementById('flow-modal').classList.remove('hidden-screen');
        flowCount = 0;
        document.getElementById('flow-fact').innerText = scienceFacts[Math.floor(Math.random()*scienceFacts.length)];
        nextFlowQuestion();
    }
    function nextFlowQuestion() {
        if(flowCount >= 5) {
            document.getElementById('flow-modal').classList.add('hidden-screen');
            if(selectedTables.length === 10) showChoiceModal();
            else finishGame();
            return;
        }
        const dots = document.getElementById('flow-dots');
        dots.innerHTML = '';
        for(let i=0; i<5; i++) dots.innerHTML += `<div class="w-2.5 h-2.5 rounded-full ${i < flowCount ? 'bg-green-500 shadow-sm' : 'bg-gray-700'}"></div>`;
        const n1 = selectedTables[Math.floor(Math.random()*selectedTables.length)];
        const n2 = Math.floor(Math.random()*10)+1;
        flowTarget = n1 * n2;
        document.getElementById('flow-question').innerText = `${n1} √ó ${n2}`;
        document.getElementById('flow-input').value = '';
        document.getElementById('flow-input').focus();
    }
    document.getElementById('flow-submit').onclick = checkFlowAnswer;
    document.getElementById('flow-input').onkeydown = (e) => { if(e.key === 'Enter') checkFlowAnswer(); };
    function checkFlowAnswer() {
        if(parseInt(document.getElementById('flow-input').value) === flowTarget) {
            flowCount++; nextFlowQuestion();
        } else {
            const input = document.getElementById('flow-input');
            input.classList.add('border-red-500');
            setTimeout(() => input.classList.remove('border-red-500'), 400);
        }
    }

    function showChoiceModal() {
        document.getElementById('choice-modal').classList.remove('hidden-screen');
        document.getElementById('current-end-score').innerText = score;
    }

    let challRemaining = 25, challTarget = 0, challTimer = CHALLENGE_TIME, challInterval;
    let challStarted = false;

    function prepareChallenge() {
        document.getElementById('choice-modal').classList.add('hidden-screen');
        document.getElementById('challenge-modal').classList.remove('hidden-screen');
        challRemaining = 25; 
        challTimer = CHALLENGE_TIME; 
        challStarted = false;
        
        document.getElementById('chall-timer').style.width = '100%';
        document.getElementById('chall-status-msg').innerText = "Eerste antwoord start de 50s klok...";
        document.getElementById('chall-status-msg').classList.remove('text-red-500');

        nextChallQuestion();
    }

    function startChallTimer() {
        if(challStarted) return;
        challStarted = true;
        document.getElementById('chall-status-msg').innerText = "Gas erop! üöÄ";
        document.getElementById('chall-status-msg').classList.add('text-yellow-500');

        challInterval = setInterval(() => {
            challTimer -= 0.1;
            document.getElementById('chall-timer').style.width = (challTimer / CHALLENGE_TIME * 100) + '%';
            if(challTimer <= 0) {
                clearInterval(challInterval);
                failChallenge();
            }
        }, 100);
    }

    function nextChallQuestion() {
        if(challRemaining <= 0) return winChallenge();
        document.getElementById('chall-count').innerText = challRemaining;
        const n1 = selectedTables[Math.floor(Math.random()*selectedTables.length)];
        const n2 = Math.floor(Math.random()*10)+1;
        challTarget = n1 * n2;
        document.getElementById('chall-question').innerText = `${n1}√ó${n2}`;
        document.getElementById('chall-input').value = '';
        document.getElementById('chall-input').focus();
    }

    document.getElementById('chall-input').oninput = checkChallAnswer;
    document.getElementById('chall-input').onkeydown = (e) => { if(e.key === 'Enter') checkChallAnswer(); };

    function checkChallAnswer() {
        const val = parseInt(document.getElementById('chall-input').value);
        if(val === challTarget) {
            if(!challStarted) startChallTimer();
            challRemaining--; 
            nextChallQuestion();
        }
    }

    function winChallenge() { clearInterval(challInterval); score *= 2; showFinalResult("DOUBLE SCORE! üî•"); }
    function failChallenge() { clearInterval(challInterval); showFinalResult("TIJD OM"); }
    function finishGame() { showFinalResult("SCORE OPGESLAGEN"); }

    function showFinalResult(status) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden-screen'));
        document.getElementById('game-over-screen').classList.remove('hidden-screen');
        document.getElementById('final-score-val').innerText = score;
        document.getElementById('score-status').innerText = status;
        let hs = JSON.parse(localStorage.getItem('ttb_scores') || '[]');
        hs.push({ name: playerName, score: score, date: new Date().toLocaleDateString() });
        hs.sort((a,b) => b.score - a.score); hs = hs.slice(0, 5);
        localStorage.setItem('ttb_scores', JSON.stringify(hs));
        const list = document.getElementById('highscore-list');
        list.innerHTML = '<p class="text-center font-black mb-2 uppercase text-yellow-500">Brein-Leaders</p>';
        hs.forEach((s, i) => {
            list.innerHTML += `<div class="flex justify-between border-b border-gray-800 pb-1"><span>${i+1}. ${s.name}</span><span class="font-bold text-white">${s.score}</span></div>`;
        });
    }

    init();
</script>
</body>
</html>